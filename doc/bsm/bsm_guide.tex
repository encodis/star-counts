%%----------------------------------------------------------------------------|
%% BSM USERS GUIDE                                                            |
%%                                                                            |
%% P. J. C. Hodder                                                            |
%%----------------------------------------------------------------------------|

\documentclass[11pt,twoside]{article}
\usepackage{psfig}
\input{bsm_macros.tex}

\begin{document}  

%%----------------------------------------------------------------------------|
%% TITLE PAGE                                                                 |
%%----------------------------------------------------------------------------|

\thispagestyle{empty}
\noindent
\framebox[16cm]{\parbox{16cm}{
{\begin{center}
\huge \bf 
A Users Guide to BSM -- 

\rule{0mm}{10mm}

A Galaxy Modelling Program

\rule{0mm}{10mm}

Version 3.2

\end{center}}}}

\rule{0mm}{10mm}

\noindent
\framebox[16cm]{\parbox{16cm}{
{\begin{center}
\large \bf
Contents
\end{center}}
\large
\begin{tabbing}
\rule{2cm}{0cm} \= \rule{1cm}{0cm} \= \kill
\> 1 \> Introduction \\ \\
\> 2 \> A Brief Review of BSM \\
\> 2.1 \> The Model \\
\> 2.2 \> Running BSM \\ \\
\> 3   \> Parameter Description and Formats \\
\> 3.1 \> Command Line Options \\
\> 3.2 \> Parameters File Keywords \\
\> 3.3 \> Input File Formats \\
\> 3.4 \> Output Format \\ \\
\> 4   \> Model Description \\
\> 4.1 \> Component Models \\
\> 4.2 \> Distribution Functions \\
\> 4.3 \> Integration Procedures \\ 
\> 4.4 \> Error Codes \\ \\
\> A \> Installing BSM \\
\> B \> Using the SM macros 
\end{tabbing}
}}

%%----------------------------------------------------------------------------|
%% INTRODUCTION                                                               |
%%----------------------------------------------------------------------------|

\newpage
\setcounter{page}{1}
\section{Introduction}

%Congratulations on your purchase of \bsm\ -- the best li'l ol' galaxy model 
%this side of Andromeda! With careful maintenance this model should  give
%Giga-years of trouble  free service -- which is just  as well because  it 
%comes with ABSOLUTELY NO WARRANTY (at NO EXTRA COST TO YOU!!)

This manual describes in detail the operation of the \bsm\ program. \bsm\
is an implementation of the Bahcall \& Soneira galaxy model and gives the
numbers of stars as a function of magnitude along a specified line of site
in our Galaxy.

This first version of \bsm\ was a rewrite in ANSI C of the 1984 
Bahcall \& Soneira galaxy model code, written in Fortran.
It used the same basic algorithms and procedures, but was faster and more 
user friendly. Version 2.0 expanded upon this idea. The code was tidied
up and more options were added. It was possible to use either the 
$r^{\frac{1}{4}}$ law for the spheroid density distribution or the 
Caldwell \& Ostriker density model. The vertical density distribution of 
a particular model could be obtained using the {\tt -z} option. 
The handling of most errors was improved with error messages. 
Version 3.0 includes an option to model a {\em thick disk} in addition
to the normal disk and spheroid components. Version 3.1 has simplified many 
things. The {\tt -co} option is no longer present, and parameter files are 
now optional (but still a good idea). The {\tt -z} option now outputs the 
counts at each distance step (not necessarily to the galactic pole). The 
parameter files are now processed in order with the command line options so 
watch out! And there are changes to the output format and other minor things.
Version 3.2 has some important changes. There are separate \cmd\ files for 
the M-S and RGB for each component. All work on the input \cmd s (applying
colour excess, using the M-S \cmd\ past the turn--off etc.) is done outside
the program. A set of utilities has been written to aid this task.

This guide is divided into 4 main sections.  This is the first section (well
duh!). Section 2 is a brief overall review of the model and how
to run \bsm. Section 3 describes the model parameters in more detail, and
Section 4 contains background information and references for some of the
scientific background. Appendix A contains the installation instructions.
Appendix B describes the macro package \bsmsm\ which makes looking at the
output a whole lot easier. Appendices C to F describe four utility programs 
that come with this release.

Bug reports and suggestions are welcome. The author of \bsm\ (Philip Hodder)
can be contacted at the Department of Geophysics and Astronomy, University of
British Columbia, \#129-2219 Main Mall, Vancouver, B.C., Canada V6T 1Z4, or
via E--mail at {\tt hodder@geop.ubc.ca}.

\vspace{10mm}
\centerline{DISCLAIMER}
\nin As far as I know this program works as described in this manual. It is
provided ``as is'' with no warranty or money back guarantee. If it doesn't
work for you then that's the way it is. Accept the fact that the Universe hates
you. Note, however, that the author can be bribed fix problems as they arise. 

\vspace{10mm}
\nin Any resemblance of these programs to any real science, programming 
ability or general usefulness is purely coincidental. 

%%----------------------------------------------------------------------------|
%% A BRIEF REVIEW OF BSM                                                      |
%%----------------------------------------------------------------------------|

\section{A Brief Review of BSM}
 
%%----------------------------------------------------------------------------|
\subsection{The Model}

The \bsm\ program computes number
counts and colour distributions for a model of our Galaxy containing two or 
three components: a thin, exponential disk and a spheroidal halo, and 
optionally, a thick disk. Using user supplied luminosity functions and 
colour--magnitude diagrams \bsm\ will integrate along a chosen line of sight 
(given by galactic coordinates $\ell,b$) and field size down to a given
limiting magnitude. Almost every parameter of the model can be altered by the
user by specifying it in a parameter file. If a parameter is not specified in 
this file a default value will be used (see \S 3).
 
%%----------------------------------------------------------------------------|
\subsection{Running BSM}

\bsm\ is run entirely from the command line -- it has no direct interaction
with the user in the form of prompts, queries and so on, although it will
print warnings before it quits when it cannot do something. A
{\em parameter file} can contain all the necessary information to successfully
produce a model -- it is therefore vital that the user fully understand
all the necessary elements of this file. This isn't as daunting as it 
sounds -- whilst there are over 50 parameters that {\em can} be specified, 
you can usually get away with using 7 or 8. The others can be changed if you 
need to. The parameter file is not required -- \bsm\ will use internal defaults
for the parameters that it needs -- but it is recommended. As well as a 
parameter file there are several command line options that set important or
often changed parameters (such as the galactic latitude and longitude of the
line of sight). Not all parameters have a specific command line option, but
there is a ``meta--option'', {\tt -P}, that can be used to set any parameter.

The parameter file should contain data concerning the line of sight you wish to
integrate along (galactic coordinates, $\ell$ and $b$), the field size (in
square degrees), the magnitude limits, and the files containing the
luminosity functions, colour--magnitude diagrams and the fraction of stars on
the main--sequence (\fms\ files). Note that unlike the
original Bahcall \& Soneira (B\&S) code, \bsm\ will work with luminosity
functions (\lf s), colour magnitude diagrams (\cmd s) and \fms\ files
in any filter combination, not just those in $V$ and $B-V$. 
This is because the user supplies this data -- it is not calculated from a 
hard--coded analytical formula during execution of the program.
This release of \bsm\ comes with a standard library of \lf s, \cmd s and
\fms s to use if you don't need anything too fancy. Also included are tools
to make your own \lf s and \fms\ files.

Section 3 contains a list of all the parameters and their defaults. 
It also lists their {\em keywords} -- i.e. the words in the parameter file 
that \bsm\ recognizes. For example, to specify a field size of 0.6 square 
degrees, you could put this line in your parameter file:
\begin{verbatim}
OMEGA = 0.6
\end{verbatim}
All keywords must be in uppercase, and the keyword and the actual value
must be separated by an equals sign. There can be any number of spaces
around the {\tt =}. Any line beginning with a \# is treated as a comment and is
ignored.

It is recommended that for the sake of consistency all parameter files end
in ``.pm'' -- \bsm\ comes with ``default.pm'' as an example. 
(Similarly, the \lf\ files in the standard library end in ``.vlf'' for a
$V$ luminosity function, ``.blf'' for $B$ etc. The \cmd\ files end in
``.vbv'' for a $V, B-V$ colour magnitude diagram, ``.ivi'' for $I, V-I$ and
so on. Files containing the fraction of main sequence stars as a
function of magnitude (\fms\ files) end in ``.vfm'' for $V$, ad nauseam.)

Although \bsm\ does not care what the \lf\ and \cmd\ files are called, it 
{\em does} matter how the data inside it is arranged (see \S3 for a description
of the various file formats). \bsm\ will first look in the current directory 
for the specified \lf, \cmd\ and \fms\ files. If it can't find them there it 
will look in the standard library. This is a directory containing a selection 
of \lf, \cmd\ and \fms\ files, whose pathname is compiled into \bsm\ during 
installation. You can, of course, add files to this library as you need them.
\bsm\ will quit (and complain) if it can't find the required files.

An example of a parameter file is shown below:
\begin{verbatim}
# Model Parameters #
L2        = 0.0
B2        = 90.0
OMEGA     = 1.0
MSC_FILE  = ms.v.bv.cm 
DGC_FILE  = dskm67.v.bv.cm
SGC_FILE  = m13.v.bv.cm
DLF_FILE  = analytic.v.lf
SLF_FILE  = analytic.v.lf
\end{verbatim}

Once the parameter file set up (you can use your favourite text editor to do 
this -- it is just a text file) or you are happy with the default values,
you can run \bsm\ by typing the following at the system prompt:
\begin{verbatim}
$ bsm my_params.pm
\end{verbatim}
The model will then be printed out to the terminal (the standard output
stream). Since the output can be quite long this is not terribly useful. 
Output can be redirected to a file of your choice:
\begin{verbatim}
$ bsm my_params.pm > my_results.dat
\end{verbatim}
Alternatively you can use the {\tt -o} switch:
\begin{verbatim}
$ bsm my_params.pm -o my_results.dat
\end{verbatim}
Note that you can specify more than one parameter file. They will be read in 
the order they occur of the command line, and parameters set in one may be
overridden by later parameter files.

This last example introduces one of the command line options.
There are several command line options that can be given to \bsm. They provide
short cuts to set parameters that frequently need to be changed whilst avoiding
the need to edit the parameter file. Whether these options override the 
parameter file depends on the order they are given in. For example, suppose
the file {\tt my\_params.pm} contains the line {\tt "OMEGA = 0.6"}. Then 
running
\begin{verbatim}
$ bsm my_params.pm -s 1.0
\end{verbatim}
will set the value of the field size to 1.0 because the {\tt -s} switch occurs
after the parameter file has been read. Switching the options:
\begin{verbatim}
$ bsm -s 1.0 default.pm
\end{verbatim}
will set the value of the field size to 0.6. Both parameter file and command 
line options override the built in defaults. These options can be useful if 
you want to run the same model for a different field and don't want to create 
another parameter file.

\bsm\ outputs the model results in one big file.
There is a short header section at the front of the file. This is
essentially a copy of all relevant parameters. The number counts are printed  
out next followed by the colour distribution. Additional blocks of data may 
then be printed (depending on various options set on the command line) and
each block is prefaced with an identifier. Section 3.4 describes the output
in more detail.

You can now split this file up into the separate pieces and display it using
whatever plotting package turns you on! \bsm\ does NO plotting itself -- a
design goal was to make it as machine independent as possible.
A macro package for SuperMongo (\sm) is included in this release. This
takes the whole file output by \bsm\ and plots the number counts and
colour distributions automatically. See Appendix B for more information.
 
\bsm\ itself is completely filter independent -- it will calculate number
counts and colour distributions in whatever filter system the input \lf s
and \cmd s are in. Two parameters, {\tt MAG\_NAME} and {\tt COL\_NAME}, can
be used to make the output look nice!

%%----------------------------------------------------------------------------|
%% PARAMETER DESCRIPTION AND FORMATS                                          |
%%----------------------------------------------------------------------------|
\newpage
\section{Parameter Description and Formats}
 
%%----------------------------------------------------------------------------|
\subsection{Command Line Options}

Although it is mentioned below it may be worth mentioning the {\tt -P} option
here in more detail. Not all the parameters that can be specified in a 
parameter file can be changed by command line switches. The {\tt -P} option 
allows you to change these other parameters on the command line. For example
\begin{verbatim}
$ bsm default.pm -P "CON_FAC = 1.0e-7"
\end{verbatim}
changes the {\tt CON\_FAC} parameter even though there is no specific switch
for it. The format of the string is the same as for the parameter file, and the
string must be enclosed in quotes to prevent expansion by the shell.

The options are:
\medskip

\begin{clo}{-a absorption\_mode}
The absorption mode to use in the model. Allowable choices are 'none', 'cosec'
and 'Sandage' for no absorption, the cosecant law and the Sandage model
respectively. Only the first letter of the word is important, and it may 
be in upper or lower case.
\end{clo}

\begin{clo}{-A absorption}
Specifies a fixed amount of absorption in the model, in addition to that
given by the {\tt -a} option.
\end{clo}

\begin{clo}{-b galactic\_latitude}
The galactic latitude of the field in decimal degrees.
\end{clo}

\begin{clo}{-ce colour\_error}
The colour error in magnitudes. The default is 0.1.
\end{clo}
  
\begin{clo}{-dm magnitude\_interval}
The apparent magnitude interval for the number counts.
\end{clo}

\begin{clo}{-dM magnitude\_interval}
The absolute  magnitude  interval for  number counts and colour distribution.
\end{clo}

\begin{clo}{-dn density\_normalization}
The density normalization of the components. This must be written as 
``disk:spheroid'' (e.g. 500:1) , or in the case of the 3 component model, 
``disk:thick:spheroid'' (e.g. 500:11.5:1).
\end{clo}

\begin{clo}{-h}
Prints a short help message.
\end{clo}

\begin{clo}{-l galactic\_longitude}
The galactic longitude of the field in decimal degrees.
\end{clo}

\begin{clo}{-L path}
Specifies an alternate directory for the .lf and .cm files.  The
default is  ``/home/hodder/lib/bsm/''  (note the ending ``/'').  The
keyword LIBRARY  may also be  used in a parameter file for  this
purpose.
\end{clo}

\begin{clo}{-mb magnitude}
The brightest apparent magnitude to be included in the model.
\end{clo}

\begin{clo}{-mf magnitude}
The faintest apparent magnitude to be included in the model.
\end{clo}

\begin{clo}{-Md magnitude}
The brightest absolute magnitude of the disk luminosity function that is
to be included.
\end{clo}

\begin{clo}{-Mf magnitude}
The faintest absolute magnitude of both the disk and spheroid luminosity
functions that is to be included in the model.
\end{clo}

\begin{clo}{-Ms magnitude}
The brightest absolute magnitude of the spheroid luminosity function that is
to be included.
\end{clo}

\begin{clo}{-Mt turn\_off\_magnitude}
The magnitude of the turn--off to be used for the spheroid. All stars brighter
than this belong to the giant branch (the spheroid is co--eval). 
\end{clo}

\begin{clo}{-o output\_file}
The file to write the finished model into. If this is not specified then
the standard output stream is used.
\end{clo}

\begin{clo}{-P parameter}
Specifies a parameter usually set in the parameter file. The string must be
quoted to prevent shell expansion. For example: {\tt -P "OMEGA = 0.1"}.
\end{clo}

\begin{clo}{-s field\_size}
The size of the field in square degrees.
\end{clo}

\begin{clo}{-t}
This tells \bsm\ to include the thick disc in the calculations. The default
is to not include this component. The parameters of this thick disk must be
set in the parameter file if anything other than the defaults values are to
be used (see \S3).
\end{clo}

\begin{clo}{-v}
This turns on ``verbose mode''. \bsm\ will print out extra data 
concerning the distribution functions used in the model. This is
mainly used for debugging purposes. See \S3.4 for more information.
\end{clo}

\begin{clo}{-z}
This option tells \bsm\ to print out the radial distribution
of stars.
\end{clo}

%%----------------------------------------------------------------------------|
\subsection{Parameter File Keywords}
There follows a list of all the parameters that can be adjusted, though 
it usually won't be necessary to change most of these. Those parameters 
marked with an asterisk ($*$) are ones that should at least be considered
before you run \bsm, even if they aren't changed. Those marked with a plus 
($+$) shouldn't be changed unless the implications are fully understood
The list is presented alphabetically by keyword with the default value in 
parentheses.
\medskip

\begin{key}{A\_0}{100.0}{}
The scale height for absorption/extinction (in parsecs).
\end{key}

\begin{key}{A\_1}{0.15}{}
The absorption in magnitudes at the Galactic poles (i.e. $a_1(90^\circ)$) in 
the ``cosec'' absorption law. The default is for the $V$ filter.
\end{key}

\begin{key}{A\_2}{0.165}{}
The $a_2$ parameter for the Sandage absorption law (see \S 4.1). The default 
value is for the $V$ filter.
\end{key}

\begin{key}{A\_3}{1.192}{}
The $a_3$ parameter for the Sandage absorption law (see \S 4.1). The default 
value is for the $V$ filter.
\end{key}

\begin{key}{ABS}{0.0}{}
A fixed value of absorption to include in the model.
\end{key}

\begin{key}{AMODE}{Sandage}{}
This keyword selects the absorption mode to be used for the model. Possible 
values are 'none, 'cosec' and 'Sandage' to use no absorption,
the cosecant law or the Sandage obscuration model. Like the {\tt -a} option
only the first letter of the word is important and it may be in upper or
lower case.
\end{key}

\begin{key}{B2}{90.0}{(*)}
The Galactic latitude of the field (in decimal degrees).
\end{key}

\begin{key}{COL\_BIN}{0.20}{(*)}
The colour bin size for output. The colour distribution will be scaled to 
number of stars per (COL\_BIN) magnitude interval.
\end{key}

\begin{key}{COL\_ERR}{0.10}{(*)}
The FWHM of the Gaussian error function convolved with the 
calculated colour distribution to produce a predicted colour distribution.
\end{key}

\begin{key}{COL\_NAME}{B-V}{}
The name of the colour scale. It has no effect on the model calculation.
\end{key}

\begin{key}{CON\_FAC}{1.0E-6}{(+)}
A convergence criterion for ceasing integration.
\end{key}

\begin{key}{DEL\_ABS}{0.05}{}
The absolute magnitude interval used during calculation.
\end{key}

\begin{key}{DEL\_APP}{1.0}{}
The apparent magnitude interval used during calculation.
\end{key}

\begin{key}{DEL\_COL}{0.05}{(+)}
The colour interval for calculation before convolution.
\end{key}

\begin{key}{DGC\_FILE}{dskm67.vbv}{(*)}
The file containing the colour--magnitude information for the disk giants.
\end{key}

\begin{key}{DLF\_FILE}{wielen.vlf}{(*)}
The file containing the \lf\ for the disk.
\end{key}

\begin{key}{DMS\_FILE}{ms.vbv}{(*)}
The file containing the main sequence colour--magnitude information for the
disk.
\end{key}

\begin{key}{DN}{500:1 | 500:10:1}{(*)}
The ratio of disk density to spheroid density in the plane of the Galaxy.
In the case of the 3 component model this refers to disk : thick disk :
spheroid density. The values can be integer or floating point (they are
converted to floating point when read).
\end{key}

\begin{key}{DR}{25.0}{}
The distance increment for integration in the disk (in parsecs).
\end{key}

\begin{key}{DSH\_B\_H}{90.0}{}
The scale height for disk stars brighter than {\tt DSH\_B\_M}. The default 
is for the $V$ band. (See \S4.2.)
\end{key}

\begin{key}{DSH\_B\_M}{2.3}{}
The scale height magnitude limit for the disk stars. Stars brighter than this
will have a scale height of {\tt DSH\_B\_H}. The default is for the $V$ band. 
(See \S4.2.)
\end{key}

\begin{key}{DSH\_F\_H}{325.0}{}
The scale height for disk stars fainter than {\tt DSH\_F\_M}. The default is 
for the $V$ band. Scale heights are linearly interpolated between this value
and {\tt DSH\_B\_H}. If {\tt DSH\_F\_H} and {\tt DSH\_B\_H} are equal \bsm\
will use that value as a constant scale height. (See \S4.2 for a complete 
explanation.)
\end{key}

\begin{key}{DSH\_F\_M}{5.1}{}
A scale height magnitude limit for the disk stars. Stars fainter than this will
have scale height of {\tt DSH\_F\_H}. The default is for the $V$ band. 
(See \S4.2.)
\end{key}

\begin{key}{E\_SPHER}{0.8}{}
The spheroid axis ratio.
\end{key}

\begin{key}{FMS\_FILE}{analytic.vfm}{(*)}
The file containing the run of fraction of stars on the main sequence as a 
function of absolute magnitude.
\end{key}

\begin{key}{GSH\_D}{250.0}{}
The scale height of the giants in the disk (in parsecs).
\end{key}

\begin{key}{GSH\_T}{1300.0}{}
The scale height of the giants in the thick disk (in parsecs).
\end{key}

\begin{key}{L2}{0.0}{(*)}
The Galactic longitude of the field (in decimal degrees).
\end{key}

\begin{key}{LIBRARY}{/home/hodder/lib/bsm}{}
The standard library of \lf, \cmd\ and \fms\ files, compiled into \bsm\ during 
installation.
\end{key}

\begin{key}{M\_BRD}{-6.0}{}
The absolute magnitude of the bright end cutoff for the disk \lf.
\end{key}

\begin{key}{M\_BRS}{-3.0}{}
The absolute magnitude of the bright end cutoff for the spheroid \lf.
\end{key}

\begin{key}{M\_DIM}{16.5}{}
The absolute magnitude of the faint end cutoff of all \lf s.
\end{key}

\begin{key}{MA\_BRT}{0.0}{}
The brightest apparent magnitude used in the model.
\end{key}

\begin{key}{MA\_DIM}{31.0}{}
The limiting apparent magnitude of the model. The integration will not be 
continued for stars fainter than this limit.
\end{key}

\begin{key}{MAG\_BIN}{0.0}{}
The magnitude bin size for the differential counts, If this is 0.0 (the
default) then no scaling is performed on the counts, otherwise the counts
are scaled from the computational bin size ({\tt DEL\_APP}) to {\tt MAG\_BIN}.
\end{key}

\begin{key}{MAG\_NAME}{V}{}
The name of magnitude scale. It has no effect on the model calculation, but 
has been included for completeness.
\end{key}

\begin{key}{MAX\_COL}{3.0}{(*)}
The maximum colour of the colour distribution. The default value of 3.0 
refers to the default $B-V$ colour.
\end{key}

\begin{key}{MBC}{0.0}{}
The brightest apparent magnitude of stars to be included in the colour 
distribution.
\end{key}

\begin{key}{MFC}{20.0}{}
The faintest apparent magnitude of stars to be included in the colour 
distribution.
\end{key}

\begin{key}{MIN\_COL}{0.0}{(*)}
The minimum colour of the colour distribution. The default value of 0.0 
refers to the default $B-V$ colour.
\end{key}

\begin{key}{MTO}{4.5}{(*)}
The magnitude of the turn--off to be used for the spheroid. All stars brighter
than this belong to the giant branch (the spheroid is co--eval). The disk
component uses a file containing the fraction of stars on the main sequence, 
not this value.
\end{key}

\begin{key}{OMEGA}{1.0}{(*)}
The size of the field (in square degrees).
\end{key}

\begin{key}{PSL\_D}{3500.0}{}
The scale length of the disk (in parsecs).
\end{key}

\begin{key}{PSL\_T}{3500.0}{}
The scale length of the thick disk (in parsecs).
\end{key}

\begin{key}{R\_0}{8000.0}{}
The distance from the Sun to the Galactic centre (in parsecs). Note that this 
is ${\rm R}_0$, not ${\rm R}_{\rm O}$ (zero not ``o'').
\end{key}

\begin{key}{R\_EK}{2670.0}{}
The de Vaucouleurs radius of the spheroid (in parsecs).
\end{key}

\begin{key}{R\_MAX\_D}{1.0E+6}{}
The maximum distance to integrate to in the disk (in parsecs).
\end{key}

\begin{key}{R\_MAX\_S}{1.0E+6}{}
The maximum distance to integrate to in the disk (in parsecs).
\end{key}

\begin{key}{R\_MAX\_T}{1.0E+6}{}
The maximum distance to integrate to in the thick disk (in parsecs).
\end{key}

\begin{key}{R\_MIN}{0.01}{}
The distance to start integration from in the disk (in parsecs).
\end{key}

\begin{key}{SGC\_FILE}{m13.vbv}{(*)}
The file containing the colour--magnitude information for the spheroid giants.
\end{key}

\begin{key}{SLF\_FILE}{dacosta.vlf}{(*)}
The file containing the \lf\ for the spheroid.
\end{key}
 
\begin{key}{SMS\_FILE}{ms.vbv}{(*)}
The file containing the main sequence colour--magnitude information for the 
spheroid.
\end{key}

\begin{key}{TGC\_FILE}{dskm67.vbv}{(*)}
The file containing the colour--magnitude information for the thick disk 
giants.
\end{key}

\begin{key}{TLF\_FILE}{wielen.vlf}{(*)}
The file containing the \lf\ for the thick disk.
\end{key}

\begin{key}{TMS\_FILE}{ms.vbv}{(*)}
The file containing the main sequence colour--magnitude information for the 
thick disk.
\end{key}

\begin{key}{TSH\_B\_H}{1300.0}{}
The scale height for thick disk stars brighter than {\tt TSH\_B\_M}. The 
default is for the $V$ band. (See \S4.2.)
\end{key}

\begin{key}{TSH\_B\_M}{2.3}{}
The scale height magnitude limit for the thick disk stars. Stars brighter 
than this will have a scale height of {\tt TSH\_B\_H}. The default is for 
the $V$ band. (See \S4.2.)
\end{key}

\begin{key}{TSH\_F\_H}{1300.0}{}
The scale height for thick disk stars fainter than {\tt TSH\_F\_M}. The 
default is for the $V$ band. Scale heights are linearly interpolated between 
this value and {\tt TSH\_B\_H}. If {\tt TSH\_F\_H} and {\tt TSH\_B\_H} are 
equal \bsm\ will use that value as a constant scale height. (See \S4.2 for a 
complete explanation.)
\end{key}

\begin{key}{TSH\_F\_M}{5.1}{}
A scale height magnitude limit for the thick disk stars. Stars fainter than 
this will have scale height of {\tt TSH\_F\_H}. The default is for the $V$ 
band. (See \S4.2.)
\end{key}

%%----------------------------------------------------------------------------|
\subsection{Input File Formats}

One of the key features of \bsm\ is the  ability of the user  to specify a
luminosity function and a colour-magnitude diagram. If  you do use  your
own you may want to check that the right parameters are set.  All of the
defaults assume a $V$ luminosity function and a $B-V$  colour.  It is also
assumed that  every entry is a  floating point number, though 
\bsm\ currently uses double precision in all floating point calculations.
All files (\lf s, \cmd s and \fms\ files) are in two column format, two numbers
per line. The first column is read as a magnitude, the second as appropriate
for the application (i.e. when reading \fms\ files the second column is assumed
to be the fraction of stars on the main sequence). In \lf\ files the second
column is the {\em log} (base 10) of the number of stars, not just the number.
Possibly this is non--intuituve, but it makes the spline fitting more robust.
Lines in the file beginning with a ``\#'' sign are treated as comments and are
ignored. \bsm\ uses dynamic allocation when reading in these data files -- 
there is no need to specify the number of lines in the file. It will be
found automatically.

\bsm\ does not require specially named files  in order to work.  However I
recommend the following  convention so we  all know what  we're  talking
about:

\begin{tabbing}
Fraction of Main Sequence Stars:xxxxxx \= source.[col]fm.xxxxxx \= e.g. analytic.vfm \kill 
Parameter Files: \> source.pm \> e.g. default.pm \\ \\
Luminosity Functions: \> source.[mag]lf \> e.g. analytic.vlf \\ \\
Colour Magnitude Diagrams: \> source.[mag][col]cm \> e.g. m13.vbv \\ \\
Fraction of Main Sequence Stars: \> source.[col]fm \> e.g. analytic.vfm 
\end{tabbing}

%%----------------------------------------------------------------------------|
\subsection{Output Format}

The output format used by \bsm\ depends somewhat on the command line options 
that have been set. The first part of the output is always a header section, 
each line of which starts with a ``\#''. The data shown here is basically a 
printout of all the parameters used to calculate the model. A copy of the 
header section of the output is shown in Figure~1 (two component model) and 
Figure~5 (three component model). The only real change is the inclusion of the 
thick disk parameters in the latter. 

The section beginning with ``{\tt Stars in COL}'' contains results for the 
colour distribution) in the order disk, spheroid and total. The first line is 
the number of stars, then the mean colours of each distribution. Next is the 
fraction of stars on the main sequence, followed by the fraction of giants in
each one. The number distribution comes next: the first 3 columns are the 
magnitude bin ranges and centre. In the next 6 columns, an ``A'' indicates
differential counts (stars per unit magnitude at the bin's mean magnitude), an
``N'' integral counts (cumulative counts down to that magnitude). The letters 
``d'', ``s'' and ``t'' indicate disk, spheroid and total counts respectively.

NOTE! Care should be taken when interpreting the differential counts if the 
magnitude bin size ({\tt MAG\_BIN}) is not equal to 0.0. In this default case 
the differential counts are in stars per magnitude bin (i.e. all the stars in
that bin between V1 and V2). Setting the magnitude bin size to anything other 
than 0.0 will make \bsm\ scale the counts to that bin size by multiplying by 
({\tt MAG\_BIN} / {\tt DM\_APP}). Therefore the magnitude bin edges in columns 
1 and 3 will {\em not} be ``correct''. The bin centre (column 2) will be 
correct -- the {\tt -bm} option merely causes scaling of the differential 
number counts. The integral counts (``N'') are not affected by this option.

Figures~2, 3 and 4 show the output format for the number counts and colour 
distributions, the radial density distribution (the {\tt -z} option) and 
the verbose output ({\tt -v}) for the two component models. The latter two 
are, of course, only printed out if the appropriate options have been set. 
Figures~6, 7 and 8 show the same things for the three component model.

The last three figures (9, 10 and 11) are plots (produced using the \sm\ macros
described in Appendix~B) of the results obtained using the test data set. (See
the entries in the ``test.pm'' file distributed with \bsm.) Only the disk
and spheroid components are shown.

The fields in the header section refer to the following:
%%--------------|
\begin{tabbing}
l \rule{2cm}{0cm} \= Galactic longitude of the field (in degrees). \\
b \> Galactic latitude of the field (in degrees). \\
A \> Field size in square degrees. \\
mabrt \> Brightest apparent magnitude at which to begin integration.\\
madim \> Faintest apparent magnitude to carry integration down to.\\
dm \> Apparent magnitude interval. \\
Mbin \> Bin size to scale counts to. \\
Mbrd \> Brightest absolute magnitude for the disk \lf . \\
Mbrs \> Brightest absolute magnitude for the spheroid \lf .\\
Mdim \> Faintest absolute magnitude for all \lf s.\\
dM \> The absolute magnitude interval. \\
Cerr \> The colour error (in magnitudes). \\
Cint \> Colour interval for calculation. \\
Cbin \> The colour bin size for scaling colour distribution. \\
maxC \> Maximum colour of the colour distribution.\\
minC \> Minimum colour of the colour distribution. \\
mbc  \> Faint apparent magnitude limit for colour distribution. \\
mfc  \> Bright apparent magnitude limit for colour distribution. \\
dr  \> The distance increment for disk integration. \\
r0  \> Distance to galactic centre (in pc). \\
abs \> Fixed value of absorption. \\
amode \> The absorption model used. \\
a0 \> Scale height of the absorption. \\
a1 \> Absorption at the Galactic poles in the ``cosec'' absorption law. \\
a2 \> The $a_2$ parameter in the Sandage absorption law (\S4.1). \\
a3 \> The $a_3$ parameter in the Sandage absorption law (\S4.1). \\
fmsfn \> File containing the fraction of stars on main -- sequence. \\
den\_d \> Density normalization of the disk. \\
psl\_d \> Scale length in the plane for the disk component (in pc). \\
gsh\_d \> Scale height of the disk giants (in pc). \\
dshfm \> Faint magnitude limit for disk star scale heights. (\S4.2).\\
dshfh \> Scale height for disk stars fainter than ``dshfm'' (\S4.2). \\
dshbm \> Bright magnitude limit for disk star scale heights. (\S4.2).\\
dshbh \> Scale height for disk stars brighter than ``dshfm'' (\S4.2). \\
dsklf \> The disk luminosity function. \\
dmcmd \> The main -- sequence colour magnitude diagram for the disk. \\
dgcmd \> The disk giant colour magnitude diagram. \\
den\_t \> Density normalization of the thick disk. \\
psl\_t \> Scale length in the plane for the thick disk component (in pc). \\
gsh\_t \> Scale height of the disk giants (in pc). \\
tshfm \> Faint magnitude limit for thick disk star scale heights. (\S4.2).\\
tshfh \> Scale height for thick disk stars fainter than ``dshfm'' (\S4.2). \\
tshbm \> Bright magnitude limit for thick disk star scale heights. (\S4.2).\\
tshbh \> Scale height for thick disk stars brighter than ``dshfm'' (\S4.2). \\
tsklf \> The thick disk luminosity function. \\
tmcmd \> The main -- sequence colour magnitude diagram for the thick disk. \\
tgcmd \> The thick disk giant colour magnitude diagram. \\
tmt \> The turn off magnitude for the thick disk. \\
tce \> The metallicity colour excess for the thick disk. \\
den\_s \> Density normalization of the spheroid. \\
rek \> The de Vaucouleurs radius of the spheroid (in pc). \\
rco \> The metallicity colour excess for the thick disk. \\
es \> The spheroid axis ratio. \\
mto \> The turn off magnitude for the spheroid. \\
sphlf \> The spheroid luminosity function. \\
smcmd \> The main -- sequence colour magnitude diagram for the spheroid. \\
sgcmd \> The spheroid giant colour magnitude diagram. \\
\end{tabbing}
%%--------------|

Additional information may be printed out at the end of the depending on
what options were set on the command line. The format of these extra data
blocks is one header line indicating the data type followed by two
columns of numbers. 

If the {\tt -z} mode has been used, the next two blocks of data will be the
$Z$ distributions of the disk (header: ZDD) and the spheroid (ZSD) in the
format: distance  number.

If ``verbose mode'' has been turned on (with the {\tt -v} option) \bsm\ will 
print out data concerning the various distribution functions that \bsm\ has 
used in the model. They are not the same as the input files that were 
specified in the parameter file. \bsm\ uses spline interpolation on the input
\lf s and \cmd s and stores the resulting look--up--table in an array.
The  {\tt -v} option just tells \bsm\ to print out these arrays.

First of these data blocks is the disk luminosity function
(header: DLF, format: magnitude  number),  then  the spheroid luminosity
function  (SLF) (format: magnitude  number).  Following  that are
three blocks  containing  the  colour-magnitude  diagrams  used:
main  sequence (MSC),  disk giant (DGC) and then  spheroid giant
(SGC) (format: magnitude colour). Finally the  fraction of stars
on the  main sequence (FMS) (format: magnitude  number) is given.

%%--------------|
%% Figure     1 |
%%--------------|
\begin{figure}[p]
\begin{center}
\begin{verbatim}
# B & S GALAXY MODEL: test.pm                                 Components: 2 
#     l =     0.000     b =    90.000     A =     1.000
# mabrt =     0.000 madim =    31.000    dm =     1.000  Mbin =     0.000
#  Mbrd =    -6.000  Mbrs =    -3.000  Mdim =    16.500    dM =     0.050
#  Cerr =     0.100  Cint =     0.005  Cbin =     0.200
#  maxC =     3.000  minC =     0.000   mbc =     0.000   mfc =    20.000
#    dr =    25.000    r0 =  8000.000   abs =     0.000 amode =   Sandage
#    a0 =   100.000    a1 =     0.000    a2 =     0.165    a3 =     1.192
# fmsfn = analytic.vfm            
#
# DSK:
# den_d =   500.000 psl_d =  3500.000 gsh_d =   250.000
# dshfm =     5.100 dshfh =   325.000 dshbm =     2.300 dshbh =    90.000
# dsklf = wielen.vlf      dmcmd = test.dms        dgcmd = test.dgb       
#
# SPH:
# den_s =     1.000   rek =  2670.000    es =     0.800     mto =     4.600
# sphlf = dacosta.vlf     smcmd = test.sms        sgbfn = test.sgb       
#
#                     DSK           SPH           TOT
# Stars in COL   =  613.451       579.378      1192.829
# Mean Colours   =    1.243         0.600         0.931
# Star Fraction  =    0.514         0.486
# Giant Fraction =    0.009         0.478         0.237
\end{verbatim}
\end{center}
\caption{The header information for the two component (disk and spheroid)
model.}
\end{figure}
%%--------------|

%%--------------|
%% Figure     2 |
%%--------------|
\begin{figure}[p]
\begin{center}
\begin{verbatim}
#
# NUM:
# V1    V     V2    Ad(V)    Nd(<V2)    As(V)    Ns(<V2)    AT(V)    NT(<V2)
-0.50  0.00  0.50 4.143e-05 4.143e-05 9.035e-08 9.035e-08 4.152e-05 4.152e-05
 0.50  1.00  1.50 2.655e-04 3.070e-04 5.423e-07 6.327e-07 2.661e-04 3.076e-04
 1.50  2.00  2.50 1.045e-03 1.352e-03 2.164e-06 2.797e-06 1.047e-03 1.355e-03
                                   ...
28.50 29.00 29.50 1.621e+00 2.514e+03 2.177e+03 1.129e+04 2.179e+03 1.381e+04
29.50 30.00 30.50 2.330e-02 2.514e+03 2.081e+03 1.338e+04 2.081e+03 1.589e+04
30.50 31.00 31.50 0.000e+00 2.514e+03 9.161e+02 1.429e+04 9.161e+02 1.681e+04
#
# COL:
#          B-V               Nd        Ns        NT
 0.0000  0.1000  0.2000     0.333     1.820     2.153
 0.2000  0.3000  0.4000     3.144    84.405    87.550
 0.4000  0.5000  0.6000    28.852   250.334   279.187
                                   ...
 2.4000  2.5000  2.6000     0.001     0.000     0.001
 2.6000  2.7000  2.8000     0.001     0.000     0.001
 2.8000  2.9000  3.0000     0.000     0.000     0.000
\end{verbatim}
\end{center}
\caption{The format for the number counts and colour distribution for the 
two component (disk and spheroid) model. The \ldots indicate data removed for
display purposes.}
\end{figure}
%%--------------|

%%--------------|
%% Figure     3 |
%%--------------|
\begin{figure}[p]
\begin{center}
\begin{verbatim}
#
#    ZDR        ZDN        ZSR        ZSN
     0.000      0.000      1.050      0.000 
    25.000      0.545      1.103      0.000 
    50.000      2.015      1.158      0.000 
                       ...
  5200.000      0.003  26826.469    170.103 
  5225.000      0.003  28167.792    156.785 
  5250.000      0.002  29576.182    142.304 
                       ...
\end{verbatim}
\end{center}
\caption{The vertical density distribution format for the two component (disk
and spheroid) model. This is output after the colour distribution when the
{\tt -z} option is used.}
\end{figure}
%%--------------|

%%--------------|
%% Figure     4 |
%%--------------|
\begin{figure}[p]
\begin{center}
\begin{verbatim}
#
# V     DLF       SLF       FMS
-6.00 1.486e-08 2.645e-09 4.407e-01
-5.95 1.614e-08 2.912e-09 4.408e-01
-5.90 1.753e-08 3.206e-09 4.409e-01
                 ...
16.40 1.372e-02 1.372e-02 1.000e+00
16.45 1.372e-02 1.372e-02 1.000e+00
16.50 1.373e-02 1.373e-02 1.000e+00
#
# V     DMS       DGC        SMS       SGC
-6.00 -3.450e-01 3.132e+00 -5.050e-01 2.768e+00
-5.95 -3.441e-01 3.117e+00 -5.041e-01 2.753e+00
-5.90 -3.433e-01 3.102e+00 -5.033e-01 2.737e+00
                 ...
16.40 2.019e+00 2.019e+00 1.859e+00 1.859e+00
16.45 2.025e+00 2.025e+00 1.865e+00 1.865e+00
16.50 2.031e+00 2.031e+00 1.871e+00 1.871e+00
\end{verbatim}
\end{center}
\caption{The information produced using verbose mode ({\tt -v}) for the two
component (disk and spheroid) model.}
\end{figure}
%%--------------|

%%--------------|
%% Figure     5 |
%%--------------|
\begin{figure}[p]
\begin{center}
\begin{verbatim}
# B & S GALAXY MODEL: test.pm                                 Components: 3 
#     l =     0.000     b =    90.000     A =     1.000
# mabrt =     0.000 madim =    31.000    dm =     1.000  Mbin =     0.000
#  Mbrd =    -6.000  Mbrs =    -3.000  Mdim =    16.500    dM =     0.050
#  Cerr =     0.100  Cint =     0.005  Cbin =     0.200
#  maxC =     3.000  minC =     0.000   mbc =     0.000   mfc =    20.000
#    dr =    25.000    r0 =  8000.000   abs =     0.000 amode =      None
#    a0 =   100.000    a1 =     0.000    a2 =     0.165    a3 =     1.192
# fmsfn = analytic.vfm            
#
# DSK:
# den_d =   500.000 psl_d =  3500.000 gsh_d =   250.000
# dshfm =     5.100 dshfh =   325.000 dshbm =     2.300 dshbh =    90.000
# dsklf = wielen.vlf      dmcmd = test.dms        dgcmd = test.dgb       
#
# THK:
# den_t =    10.000 psl_t =  3500.000 gsh_t =  1300.000
# tshfm =     5.100 tshfh =  1300.000 tshbm =     2.300 tshbh =  1300.000
# thklf = wielen.vlf      tmcmd = ms.vbv          tgbfn = dskm67.vbv     
#
# SPH:
# den_s =     1.000   rek =  2670.000    es =     0.800     mto =     4.600
# sphlf = dacosta.vlf     smcmd = test.sms        sgbfn = test.sgb       
#
#                     DSK           THK           SPH           TOT
# Stars in COL   =  613.451       398.355       579.378      1591.184
# Mean Colours   =    1.243         0.813         0.600         0.902
# Star Fraction  =    0.386         0.250         0.364
# Giant Fraction =    0.009         0.037         0.478         0.187
\end{verbatim}
\end{center}
\caption{The header information for the three component (disk, thick disk
and spheroid) model.}
\end{figure}
%%--------------|

%%--------------|
%% Figure     6 |
%%--------------|
\begin{figure}[p]
\begin{center}
\begin{verbatim}
#
# NUM:
# V1    V     V2    Ad(V)    Nd(<V2)    At(V)    Nt(<V2)
-0.50  0.00  0.50 4.143e-05 4.143e-05 1.125e-06 1.125e-06
 0.50  1.00  1.50 2.655e-04 3.070e-04 7.700e-06 8.825e-06
 1.50  2.00  2.50 1.045e-03 1.352e-03 3.346e-05 4.229e-05
                           ...
28.50 29.00 29.50 1.621e+00 2.514e+03 2.128e+02 3.046e+03
29.50 30.00 30.50 2.330e-02 2.514e+03 8.308e+01 3.129e+03
30.50 31.00 31.50 0.000e+00 2.514e+03 7.696e+00 3.136e+03
# V1    V     V2    As(V)    Ns(<V2)    AT(V)    NT(<V2)
-0.50  0.00  0.50 9.035e-08 9.035e-08 4.264e-05 4.264e-05
 0.50  1.00  1.50 5.423e-07 6.327e-07 2.738e-04 3.164e-04
 1.50  2.00  2.50 2.164e-06 2.797e-06 1.080e-03 1.397e-03
                           ...
28.50 29.00 29.50 2.177e+03 1.129e+04 2.391e+03 1.685e+04
29.50 30.00 30.50 2.081e+03 1.338e+04 2.164e+03 1.902e+04
30.50 31.00 31.50 9.161e+02 1.429e+04 9.238e+02 1.994e+04
#
# COL:
#          B-V               Nd        Nt        Ns        NT
 0.0000  0.1000  0.2000     0.333    13.158     1.820    15.311
 0.2000  0.3000  0.4000     3.144    25.831    84.405   113.381
 0.4000  0.5000  0.6000    28.852    70.748   250.334   349.935
                           ...
 2.4000  2.5000  2.6000     0.001     0.003     0.000     0.005
 2.6000  2.7000  2.8000     0.001     0.001     0.000     0.002
 2.8000  2.9000  3.0000     0.000     0.000     0.000     0.001
\end{verbatim}
\end{center}
\caption{The format for the number counts and colour distribution for the 
three component (disk, thick disk and spheroid) model.}
\end{figure}
%%--------------|

%%--------------|
%% Figure     7 |
%%--------------|
\begin{figure}[p]
\begin{center}
\begin{verbatim}
#
#    ZDR        ZDN        ZTR        ZTN        ZSR        ZSN
     0.000      0.000      0.000      0.000      1.050      0.000 
    25.000      0.545     25.000      0.012      1.103      0.000 
    50.000      2.015     50.000      0.045      1.158      0.000 
                                 ...
  5200.000      0.003   5200.000      9.360  26826.469    170.103 
  5225.000      0.003   5225.000      9.271  28167.792    156.785 
  5250.000      0.002   5250.000      9.181  29576.182    142.304 
                                 ...
\end{verbatim}
\end{center}
\caption{The vertical density distribution (using the {\tt -z} option) for 
the three component (disk, thick disk and spheroid) model.}
\end{figure}
%%--------------|

%%--------------|
%% Figure     8 |
%%--------------|
\begin{figure}[p]
\begin{center}
\begin{verbatim}
#
# V    DLF       TLF       SLF       FMS
-6.00 1.486e-08 1.486e-08 2.645e-09 4.407e-01
-5.95 1.614e-08 1.614e-08 2.912e-09 4.408e-01
-5.90 1.753e-08 1.753e-08 3.206e-09 4.409e-01
                    ...
16.40 1.372e-02 1.372e-02 1.372e-02 1.000e+00
16.45 1.372e-02 1.372e-02 1.372e-02 1.000e+00
16.50 1.373e-02 1.373e-02 1.373e-02 1.000e+00
#
# V     DMS       DGC        TMS       TGC        SMS       SGC
-6.00 -3.450e-01 3.132e+00 -3.450e-01 3.132e+00 -5.050e-01 2.768e+00
-5.95 -3.441e-01 3.117e+00 -3.441e-01 3.117e+00 -5.041e-01 2.753e+00
-5.90 -3.433e-01 3.102e+00 -3.433e-01 3.102e+00 -5.033e-01 2.737e+00
                    ...
16.40 2.019e+00 2.019e+00 2.019e+00 2.019e+00 1.859e+00 1.859e+00
16.45 2.025e+00 2.025e+00 2.025e+00 2.025e+00 1.865e+00 1.865e+00
16.50 2.031e+00 2.031e+00 2.031e+00 2.031e+00 1.871e+00 1.871e+00
\end{verbatim}
\end{center}
\caption{The information produced using the {\tt -v} option for the three 
component (disk, thick disk and spheroid) model.}
\end{figure}
%%--------------|

%%--------------|
%% Figure     9 |
%%--------------|
\begin{figure}[p]
\centerline{\psfig{figure=icounts.eps}}
\caption{The integral number counts for the test model.}
\end{figure}

%%--------------|
%% Figure    10 |
%%--------------|
\begin{figure}[p]
\centerline{\psfig{figure=dcounts.eps}}
\caption{The differential number counts for the test model.}
\end{figure}

%%--------------|
%% Figure    11 |
%%--------------|
\begin{figure}[p]
\centerline{\psfig{figure=coldist.eps}}
\caption{The colour distribution produced by the test model.}
\end{figure}
%%--------------|

%%----------------------------------------------------------------------------|
%% MODEL DESCRIPTION                                                          |
%%----------------------------------------------------------------------------|

\newpage
\section{Model Description}

%%--------------------------|
\subsection{Component Models}

There are currently only two components in \bsm\ -- the thin, exponential
disk and the spheroidal halo. The functional forms discussed below have been
hard--coded into the program and cannot be changed without rewriting the
appropriate subroutines. The parameters in these functional forms can,
of course, be set by the user.

%%----------------------|
\subsubsection*{The Disk}

The density  distribution of  the disk stars in the Bahcall and  Soneira
model is represented by the following exponential function:
\[ 
\rho_d(r,M) = e^{\left[\frac{-z}{H(M)} - \frac{x-R_0}{h} \right]}
\] 
where the  scale height of the disk,  $H(M)$, is a  function  of  absolute
magnitude, and $h$ is the scale length. $R_0$ is the distance of the Sun from
the Galactic centre (in pc).
 
%%--------------------------|
\subsubsection*{The Spheroid}

de Vaucouleurs (1959,  in  Handbuch  der Physik, Vol. 53,  ed. S. Flugge
(Berlin, Springer--Verlag), p. 311) found  that the projected  brightness
distribution of ellipticals was given by the famous $r^\frac{1}{4}$ law:
\[
\log \frac{I(r)}{I(r_e)} = -3.3307 \left( \left(\frac{r}{r_e}\right)^
{\frac{1}{4}} - 1 \right)
\]
where  $r_e$  is the spatial distance that  projects to an angle containing
half the total luminosity. Young (1976, AJ, 81, 807) gives an asymptotic
approximation for the spatial density of stars  which leads to this form
of projection:
\[
\rho_s(r) \approx \frac{e^{-b\left(\frac{r}{r_e}\right)}}
{2\left(\frac{r}{r_e}\right)^3}
\left( \frac{\pi}{8 b \left(\frac{r}{r_e}\right)} \right)^{\frac{1}{2}}
\]
where $b = 7.6692$.

The disk and spheroid density distributions are normalised by the factor
given in DN (the default is 500:1).

%%------------------------|
\subsubsection*{Absorption}

Three different models for galactic absorption are currently supported -- no
absorption, the ``cosec'' law and the Sandage absorption law, the latter being
the default model. The absorption model can be specified on the command line
(the {\tt -a} option) or in the parameter file with the keyword {\tt AMODE}. 
In both cases the words 'none', 'cosec' and 'Sandage' can be used to choose the
desired model. Only the first letter of the word (which may be in upper or
lower case) is significant.

Each absorption mode needs various parameters (except the no absorption
case!). The cosecant law calculates absorpion based on the formula
\[
A(b) = a_1(90^\circ) \csc b
\]
where $a_1(90^\circ) = 0.15$ magnitudes in $V$ (the default) and 
$A_V = 0.75 A_B$. This coefficient can be specified in the parameter file
with the A\_1 keyword. You will have to decide on the value of this parameter
for other filters on your own.

The Sandage absorption model (Sandage, 1972, ApJ, 178, 1) in the $V$ band is
\[
\begin{array}{lll}
A(b) = & a_2 ( a_3 - \tan b) \csc b & |b| \leq 50^\circ \\
A(b) = & 0 & |b| > 50^\circ
\end{array}
\]
where for the $V$ filter $a_2 = 0.165$ and $a_3 = 1.192$. In the $B$ filter
$A_B = 1.33 A_V$. To the best of my knowledge this formula is only defined
for the $V$ and $B$ filters. The parameters $a_2$ and $a_3$ can be 
reset in the parameter file with the {\tt A\_2} and {\tt A\_3} keywords 
respectively.

Finally the absorption in magnitudes at distance $R$ is calculated from
\[
A(R) = A(b) \left[ 1 - e^{(- \sin b / a_0) R} \right]
\]
where $a_0$ is the scale height of the absorbing material. The default is
100 pc, and the appropriate keyword is {\tt A\_0}. It is assumed there is no
variation with distance from the Galactic centre, only an exponential
variation perpendicular to the plane.

%%----------------------------------------------------------------------------|
\subsection{Distribution Functions}

The original (FORTRAN) version of \bsm\ had the analytical form for the
\lf s, \cmd s and fraction of main sequence stars hard--coded into the
program, making it very difficult to change them. To improve flexibility
and ease of use these functions are now stored as data files, which
\bsm\ reads in and interpolates on to get the values it needs.

%%----------------------------------|
\subsubsection*{Luminosity Functions}

In this release of \bsm, three files are given for the luminosity function
of the disk (``analytic.vlf'', ``wielen.vlf'', and ``dacosta.vlf''). 
The first of these, the pure analytic LF, is given by equation (1) of 
Bahcall and Soneira 1980 (ApJS, 44, 73):
\[
\begin{array}{lll}
\phi(M) = & \frac{n_\ast 10^{\beta(M-M_\ast)}}
{\left( 1 + 10^{-(\alpha - \beta)\delta(M-M_\ast)}\right)^{\frac{1}{\delta}}}
& M_b \leq M \leq M_c \nonumber \\
\phi(M) = & \phi(M_c) & M_c \leq M \leq M_d  \\
\phi(M) = & 0 & M \leq M_b {\rm ~or~~} M \geq M_d
\end{array}
\]
where, for the $V$ band, $n_\ast = 4.03 \times 10^{-3}$, $M_\ast = +1.28$, 
$\alpha = 0.74$, $\beta = 0.04$, $\frac{1}{\delta} = 3.40$, $M_b = -6$, 
$M_c = +15$ and $M_d = +19$. This formula is used by the utility \mkalf\
to make analytical \lf s (see Appendix C).
 
This has been modified to include the ``Wielen dip'' (Wielen, 1974, in
Highlights of Astronomy, Vol. 3, ed. G. Contopoulos (Dordrecht, Reidel), 
p. 365) in the file ``wielen.vlf'' and further modified to include the so--
called ``globular  cluster feature''  (DaCosta, 1982, AJ, 87, 990) in  the
file ``dacosta.vlf''. As discussed in Bahcall and Soneira (1980)  these can
probably be used for the spheroid \lf\ without too much of a problem.

The parameters in this equation can be changed for different bandpasses.
The utility program \mkalf\ will produce
LFs for other bands using parameters stored in ``lfdata.col''. This file
comes with the standard \bsm\ library.

%%----------------------------------------|
\subsubsection*{Colour--Magnitude Diagrams}

\bsm\ uses \cmd s only to calculate the expected colour distribution of the
field in question. Thus if you are interested in say, number counts in $I$
but have no $V-I$ \cmd, you could run \bsm\ with an $I$ band \lf\ and ignore 
the colour distribution that \bsm\ produces.

Several \cmd s are provided with \bsm\ in the standard library. These have
come mainly from the functions supplied with the FORTRAN version of \bsm.

%%------------------------------------------------|
\subsubsection*{Fraction of Stars on Main Sequence}

During the calculation of the model \bsm\ needs to know the fraction of
stars on the main sequence as a function of absolute magnitude. This is
so it can weight the giant branch and main sequence number counts
accordingly. Mamon \& Soneira, 1982 (ApJ, 255, 181) give the following
analytical form for the number of stars on the main sequence:
\[
\begin{array}{lll}
f(M) = & C e^{\alpha(M+\beta)^{\gamma}} & M < M_a \\
f(M) = & 1 & M \geq M_a
\end{array}
\]
where for the $V$ band, $C=0.44$, $\alpha = 1.5\times10^{-4}$, $\beta=8.0$,
$\gamma=3.5$ and $M_a = 3.7$. These parameters vary for each band, and are
stored in ``fmsdata.col'' in the standard library (see the description of
the \mkfms\ utility in Appendix E). The default file ``analytic.vfm'' is
supplied in the standard library.

%%------------------------------------------|
\subsubsection*{Scale Heights for Disk Stars}

The scale height of main sequence disk stars has been shown to be a function 
of absolute magnitude. This variation has been hard coded into \bsm\ to be a
linear variation between two points in scale height --  magnitude space, 
though this may change in future versions. The scale height $S$ depends on 
magnitude $M$ as follows:
\[
S = s_z + s_c M
\]
where $s_z$ and $s_c$ are calculated from two points given by the keywords
({\tt DSH\_F\_H}, {\tt DSH\_F\_M}) and ({\tt DSH\_B\_H}, {\tt DSH\_B\_M}). 
For magnitudes between {\tt DSH\_F\_M} and {\tt DSH\_B\_M} the scale height is
found by linear interpolation. At brighter or fainter magnitudes the scale 
height is fixed to {\tt DSH\_B\_H} and {\tt DSH\_F\_H} respectively. 
Figure~12 shows this graphically.
%%--------------|
%% Figure    12 |
%%--------------|
\begin{figure}[t]
\centerline{\psfig{figure=sheight.eps}}
\caption{The variation of scale height with magnitude.}
\end{figure}
%%--------------|

If {\tt DSH\_F\_H} and {\tt DSH\_B\_H} are the same then \bsm\ will use that 
height as a constant scale height. Similar relations are applied for the thick 
disk stars ({\tt TSH\_F\_H} etc.). The scale height of the giants, which is 
assumed to be constant, may be selected using the {\tt GSH\_D} and 
{\tt GSH\_T} parameters.

%%----------------------------------------------------------------------------|
\subsection{Integration Procedure}

% HOW THE COL DIST USED TO BE
%These latter two entries need some explanation, but
%this requires  you to know  something about  how the  model is  actually 
%calculated so bear with me. \bsm\ will read the 3 \cmd\ files and use spline 
%interpolation  to make  3  large arrays to use  as ``look up tables'' when
%calculating colour from absolute magnitude. The main sequence (MS) array
%is just the  interpolation of  the MS \cmd\ file.  For values of absolute
%magnitude  brighter than ${\rm M}_{\rm TO}$ the disk giant  (DG)
%array is comprised of the spline  interpolation of the DG file minus the
%value of ${\rm C}_{\rm ME}$.  This represents the shift due to the metallicity
%colour excess. For magnitudes fainter than the turn off,  the values for
%the MS array are used (minus ${\rm C}_{\rm ME}$).  The spheroid giant (SG)
%array is formed in a similar, but not identical way. Above the turn off,
%the array is the spline interpolation of the SG file with no subtraction
%for colour excess. At magnitudes below this the MS values are again used
%(with the ${\rm C}_{\rm ME}$ subtracted). Clear as mud? Good.

This section describes how \bsm\ produces a model. It is reasonably 
detailed and is {\em not} required reading. In some cases it refers to 
what the computer is actually doing, so if you're really interested
you may want to have a copy of the source code close at hand.
The discussion also assumes that all the files \bsm\ needs are available
and that it won't crash!

The first thing \bsm\ does is initialize all the parameters to default
values. Then it reads the parameter file (given on the command line)
one line at a time. If it comes across an invalid keyword it will stop,
otherwise it will overwrite the default values of those parameters the
user gave in the parameter file. It then looks at any command line
options and updates the appropriate parameters.

Next \bsm\ initializes various look--up--tables (LUT) that it needs. These are
arrays for the \lf, \cmd\ and \fms\ data. From it's parameters it determines
the size of the array needed and reads in the data file. It performs
spline interpolation on this file to fill in the array. Several arrays are
needed -- one each for the disk and spheroid \lf s, three for the main
sequence, disk giant and spheroid giant color magnitude diagrams and one
for the \fms\ data. Other arrays used to hold the results of the
integration (number counts and colour distribution) are also set up at this
time but are merely initialized to zero.

\bsm\ can now begin to do the calculation. It starts with the disk component
first. Starting at {\tt R\_MIN} it moves along the line of sight in steps of 
{\tt DR}. At each step the size of the volume element, vertical and horizontal
distances and absorption are calculated. Then the program steps through 
the luminosity function to calculate the number counts and colour 
distribution that this volume element contributes to the model. 

For each absolute magnitude step, the apparent magnitude is calculated 
from the distance and absorption. The scale height for the main sequence 
stars is calculated and the fraction of stars on the main sequence is
found from the \fms\ LUT. The number of stars is then found by multiplying
together the volume element, the \lf\ at that (absolute) magnitude, the
\fms\ value and the density distribution, evaluated at that position.

The effect on the colour distribution is found by looking up the colour
corresponding to that absolute magnitude on the \cmd\ LUTs. The count
for that particular colour is filled in and various other running totals
are computed.

The program then loops back for the next magnitude step in the \lf, then
when that loop is finished proceeds to the next distance step and so on.
Integration is terminated when all loops have been finished or when
the following condition is met. The total counts accumulated over the
\lf\ loop are compared to the running grand total of counts. If this 
sub total is less than {\tt C\_FAC} times the grand total then an insignificant
amount of stars are being added and the integration stops.

The calculation of the spheroid counts proceeds in pretty much the same way,
except for one major difference. Because of the typically large numbers
involved, the distance integration is done in log space.

After this all that remains is some ``tidying up''. The computed colour
distribution is convolved with a Gaussian error distribution to obtain the 
predicted colour distribution. Various other ``colour'' statistics are also
worked out. The total of the number counts are found, as is the integral
number counts for the disk and spheroid.
The results are then written out on the standard output stream.

There are undoubtably many ways to improve performance -- these are being
looked into. As far as accuracy is concerned, this model has been compared 
to the original FORTRAN version and seems to be a good match to within 1 
star in 2000.

%%----------------------------------------------------------------------------|
\subsection{Error Codes}

This section will only be useful for a few people, but it should be written
down somewhere! If \bsm\ runs to completion the normal exit status is 0.
If, at any point during execution, \bsm\ encounters an error it will stop,
with an error message and the appropriate exit status.

\begin{table}[h]
\centering
\begin{tabular}{|c|l|} \hline
Status & Meaning \\ \hline
 0 & successful completion of program \\
 1 & usage error - help requested \\
 2 & usage error - keyword help requested \\
 3 & invalid command line option \\
 4 & invalid parameter in parameter file \\
 5 & file open error (file does not exist) \\
 6 & file read error \\
 7 & memory allocation error \\
 8 & math error \\ \hline
\end{tabular}
\end{table}

%%----------------------------------------------------------------------------|
%% APPENDIX A                                                                 |
%%----------------------------------------------------------------------------|
\newpage

\section*{Appendix A -- Installing BSM}

Before installing \bsm\ you should read ALL the documentation. \bsm\ should
install without too much trouble, but you never know \ldots If you have  any
problems contact the author via e-mail at {\tt hodder@geop.ubc.ca}.
Assuming you have, or can get, the file \bsmver\ (available from the
author or via FTP) you should do the following:
\bigskip

\begin{enumerate}
\item Ensure you have an ANSI C compiler on your system.  The GNU  compiler
gcc works just fine (\bsm\ was developed with it). If you don't have one 
you're out of luck. Talk to your local UNiX wizard.

\item Make a directory for the source code.
\begin{verbatim}
$ mkdir /home/fred/bsmsrc
\end{verbatim}

\item Change to that directory and move the \bsmver\ file into it.
\begin{verbatim}
$ cd bsmsrc
$ mv ../bsm-3.2.tar.gz .
\end{verbatim}

\item If you have the tarred, compressed file then uncompress and untar it (!):
\begin{verbatim}
$ zcat bsm-3.2.tar.gz | tar xvf -
\end{verbatim}

\item If you have the zipped file and access to unzip:
\begin{verbatim}
$ unzip BsmSrc32.zip
\end{verbatim}

\item You should also have an archive containing the library \lf and \cmd\
files (called something like BsmLib10.zip or bsmlib-1.0.tar.gz). Unpack these
to a separate directory in a similar way.

\item Unpacking the file will create several files, most of them C code.
Edit the Makefile. Change the definition of BINDIR to where you want the
executables to live. Change the definition of BSMLIB to point to where you
unpacked the library files.

\item Make the executable:
\begin{verbatim}
$ make bsm
\end{verbatim}

\item If everything  works O.K  there  should  be no  error messages during
compilation. If not then see below for troubleshooting.

\item Test the code using the following commands:
\begin{verbatim}
$ ./bsm test.pm > my_test
$ diff my_test test.bsm
\end{verbatim}
There should be no output from the {\tt diff} command if the files are the 
same. Note that ``test.bsm'' and the \lf s and \cmd s it uses come with the 
distribution.

\item Clean up the src directory:
\begin{verbatim}
$ make clean
\end{verbatim}

\item Install the programs:
\begin{verbatim}
$ make install
\end{verbatim}

\item If you have \LaTeX\ installed on your system make the manual:
\begin{verbatim}
$ make manual
\end{verbatim}
If all goes well there will be a file called ``bsm\_guide.ps'' in the ``doc''
subdirectory which you can print out.
\end{enumerate}

%%----------------------------------------------------------------------------|
\subsection*{Troubleshooting}

Most of the problems with \bsm\ will probably occur during compilation.
\bsm\ uses many ANSI C constructs so it must be compiled with an ANSI C 
compatible complier (such as gcc). If you don't have gcc, or something 
like it, you can try to get a conversion program to convert ANSI to K\&R 
(traditional) C.

Other problems may occur with the library  of \lf, \cmd\ and \fms\ files. 
Please note that these are provided as examples and you are encouraged to make
your own. (If you do send them to me and so I can include them in the 
``official'' distribution). \bsm\ does not care where these files are -- just
as long as you tell it where. After looking in the current directory, the 
default directory to look for these files is compiled into \bsm\ (hence step 
6). If you don't mind the tedium of it, and don't want to move the library 
around you can use the -f option on the command line to force \bsm\ to look 
somewhere else.

%%----------------------------------------------------------------------------|
\subsection*{Running BSM at UBC}

If you are at UBC you do not need to do any installation -- the current
version of \bsm\ lives in  /home/hodder/bin. Add  this to your path if  you
want, or copy the executable.  The library of .cm and .lf files lives in 
/home/hodder/lib/bsm -- this  has  been compiled into \bsm\ as the default
library.
 
%%----------------------------------------------------------------------------|
%% APPENDIX B                                                                 |
%%----------------------------------------------------------------------------|

\section*{Appendix B -- Using the \sm\ macros}

In this release of \bsm\ (Version 3.1) a set of \sm\ macros is provided in
the file \bsmsm. In its basic form you can just use it to read the
results from a run of \bsm\ with the \bsmplot\ macro:
\begin{verbatim}
$ sm
SM> device x11
SM> macro read bsm.sm
SM> bsm_plot my_results.dat
\end{verbatim}
This will plot 3 diagrams -- one for each of the differential number
counts, integral number counts and the colour distribution. The number
counts are converted to log form before plotting. 

Once the \bsmsm\ file has been read, you will have
access to several other macros. These are \bsmdiff, which plots the
differential counts, \bsmint\ which plots the integral counts and
\bsmcol\ for plotting the colour  distribution. There is also a 
macro called \bsminfo, which prints  out the header information  (this
is probably a gross misuse of a plotting package but it keeps everything
together nicely). In addition, \bsmread\ can be used to ``load'' the data
in the parameter file into \sm. It takes the filename as an argument and
scans the header section of the file, defines a large group of variables
from it, and reads data into several vectors. The variables have the
same names as in the header section,  i.e. you can get the field size by
using \$A, the disk turn off
magnitude by using \$dmt, and so on. The colour distribution results are
also read. The variables are \$tcdsk, \$tcsph and \$tctot for the number of
stars  in the  distribution;  \$acdsk, \$acsph  and \$actot  for  the  mean
colours;  \$sfdsk and \$sfsph  for  the fraction  of  stars  on  the  main
sequence; and \$gfdsk, \$gfsph and \$gftot for the fraction of giant stars.
The vectors defined by \bsmread\ are mag for the magnitude range,
log\_ad for the log of the differential disk counts, log\_ns for the log
of the integral spheroid counts, and so on.
You can now use these macros and  variables in \sm\ to  make plots of your
own. Note that to then plot a different results file you will have to
use the \bsmread\ macro a second time, in order to read the new file and to
redefine the variables.

\end{document}
